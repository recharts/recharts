# This workflow runs all CI steps within a single job.

name: Build and test

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

env:
  NODE_VERSION: 24.x
  PACKED_ARTIFACT_NAME: 'recharts-snapshot.tgz'

jobs:
  list_integration_tests:
    name: List Integration Test Directories
    runs-on: ubuntu-latest
    outputs:
      # Output the list of directories as a JSON array string
      directories: ${{ steps.set_matrix.outputs.directories }}
    steps:
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Checkout Integration Tests Repository
        uses: actions/checkout@v4
        with:
          repository: recharts/recharts-integ

      - name: List Integration Test Directories
        id: set_matrix
        # This command finds all integration test directories
        # and formats them as a JSON array.
        run: |
          JSON_ARRAY=$(node list.js --ci --json)
          echo "Generated directory list: $JSON_ARRAY"
          echo "directories=$JSON_ARRAY" >> $GITHUB_OUTPUT

  build_test_pack:
    name: Build, Test, Pack
    runs-on: ubuntu-latest
    container:
      # Use the Playwright container to run tests, as recommended in https://storybook.js.org/docs/writing-tests/in-ci
      # Make sure to grab the latest version of the Playwright image
      # https://playwright.dev/docs/docker#pull-the-image
      image: mcr.microsoft.com/playwright:v1.58.0-jammy
    env:
      ENCRYPTED_CHROMATIC_TOKEN: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
      # /root home is required to allow Firefox to run in the container
      HOME: /root
    outputs:
      # Output the *name* of the generated tgz file (relative to RECHARTS_PATH)
      # The actual file will be passed via artifact
      tgz_name: ${{ steps.pack_library.outputs.tgz_name }}
    steps:
      - name: Checkout Recharts Repository
        uses: actions/checkout@v4
        with:
          # Chromatic needs access to full git history
          # see https://www.chromatic.com/docs/github-actions/
          fetch-depth: 0

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          # Cache depends on the lock file within the checked-out path
          cache-dependency-path: 'package-lock.json'

      - name: Install Dependencies
        run: npm ci

      - name: Check Playwright versions
        run: npm run check-playwright-versions

      - name: Build main lib
        run: npm run build

      - name: Calculate BASE_URL
        id: base_url
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "BASE_URL=/recharts/pr-${{ github.event.pull_request.number }}/www/" >> $GITHUB_ENV
          else
            echo "BASE_URL=/recharts/canary/www/" >> $GITHUB_ENV
          fi

      - name: Build website
        working-directory: www
        run: npm run build
        env:
          BASE_URL: ${{ env.BASE_URL }}

      - name: Unit Tests
        run: npm run test-coverage

      - name: Typecheck
        run: npm run check-types

      - name: Lint
        run: npm run lint

      - name: Verify Public Exports
        run: npm run test-exports

      - name: omnidoc - documentation test
        run: npm run test-omnidoc

      - name: Storybook doctor
        run: npm run storybook-doctor

      - name: Storybook Test
        run: npm run test-storybook
        timeout-minutes: 10

      - name: Storybook Build
        run: npm run build-storybook

      - name: Copy storybook to docs folder
        run: |
          mkdir www/docs/storybook-static
          cp -r storybook/public/* www/docs/storybook-static/

      - name: Upload website artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-build
          path: www/docs
          retention-days: 14

      - name: Pack Library
        # Give this step an ID so we can reference its output
        id: pack_library
        run: |
          # Run npm pack and capture the output filename (relative to current dir)
          tgz_filename=$(npm pack | tail -n 1)
          # rename from the default packed name to PACKED_ARTIFACT_NAME so that we don't need to guess the name later.
          # artifact upload/download in GitHub has a 'name' property but that's the artifact name, not the file name.
          mv $tgz_filename ${{ env.PACKED_ARTIFACT_NAME }}
          echo "Packed library file: $tgz_filename renamed to ${{ env.PACKED_ARTIFACT_NAME }}"
          echo "tgz_name=${{ env.PACKED_ARTIFACT_NAME }}" >> $GITHUB_OUTPUT

      - name: Upload Packed Library Artifact
        uses: actions/upload-artifact@v4
        with:
          # This is the "artifact name", it's not a file name. The file name remains original.
          name: ${{ env.PACKED_ARTIFACT_NAME }}
          # Upload the file specified by the output of the 'pack_library' step
          path: ${{ steps.pack_library.outputs.tgz_name }}
          retention-days: 14

      # Now that we know all the tests are passing, let's report code coverage
      - name: Upload coverage report to Codecov
        uses: codecov/codecov-action@v5
        with:
          slug: recharts/recharts
          files: ./coverage/coverage-final.json
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload bundle analysis report to Codecov
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: node ./scripts/upload-bundle-analysis.js

      # Chromatic gives us only this many free credits per month
      # so let's publish only at the end so that we don't waste them when we know we can't merge from the previous steps anyway.
      - name: Publish visual regression tests to Chromatic
        if: ${{ env.ENCRYPTED_CHROMATIC_TOKEN }}
        # Chromatic action from https://www.chromatic.com/docs/github-actions
        uses: chromaui/action@latest
        # Chromatic GitHub Action options
        with:
          # ðŸ‘‡ Chromatic projectToken, refer to the manage page to obtain it.
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          # Let's say that we don't want to use our Chromatic credits for PRs from dependabot
          skip: 'dependabot/**'

  integration_tests:
    name: Test ${{ matrix.test_dir }}
    runs-on: ubuntu-latest
    needs: [list_integration_tests, build_test_pack]
    strategy:
      # Allow all integration tests to run even if one fails
      fail-fast: false
      matrix:
        # Dynamically generate the matrix from the JSON output of the previous job
        test_dir: ${{ fromJson(needs.list_integration_tests.outputs.directories) }}
    steps:
      - name: Checkout Integration Tests Repository
        uses: actions/checkout@v4
        with:
          repository: recharts/recharts-integ # Checkout the test repo again but this time all directories and files

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          cache: true

      - name: Download Packed Library Artifact
        uses: actions/download-artifact@v4
        with:
          # name is not the filename, it's the "artifact name". The actual filename is the original of what was uploaded.
          name: ${{ env.PACKED_ARTIFACT_NAME }}
          # path is the directory where the artifact will be downloaded
          # so the full path to the artifact will be ${{ runner.temp }}/${{ env.PACKED_ARTIFACT_NAME }}
          path: ${{ runner.temp }}

      - name: Run Test
        # Use the output from the 'pack_library' step
        run: ./run-test.sh "${{ matrix.test_dir }}" "file:${{ runner.temp }}/${{ env.PACKED_ARTIFACT_NAME }}"

  vr_tests:
    name: Visual Regression Tests
    permissions:
      contents: read
      pages: write
      id-token: write
      pull-requests: write
    runs-on: ubuntu-latest
    needs: [build_test_pack]
    env:
      # GH_TOKEN is needed to use `gh` CLI to comment on the PR
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout Recharts Repository
        uses: actions/checkout@v4
        with:
          repository: recharts/recharts # Checkout the main repo again but this time all directories and files

      - name: Sanitize branch name
        # The branch name is used in the URL for the report.
        # It needs to be sanitized to remove characters that are not URL-friendly.
        # This step creates a GITHUB_ENV variable so it can be reused in later steps.
        run: |
          BRANCH_NAME=${{ github.head_ref || github.ref_name }}
          # Sanitize branch name for URL
          SANITIZED_BRANCH_NAME=$(echo $BRANCH_NAME | sed 's/[^a-zA-Z0-9]/-/g')
          echo "SANITIZED_BRANCH_NAME=$SANITIZED_BRANCH_NAME" >> $GITHUB_ENV

      - name: Build Docker Image
        # The VR tests run inside a Docker container. This step builds the image.
        run: npm run test-vr:prepare

      - name: Run Visual Regression Tests
        id: vr_test_step
        run: npm run test-vr
        # Continue even if this step fails. This allows us to upload the report
        # and post a comment on the PR. The workflow will be failed in a later step.
        continue-on-error: true

      - name: Upload Visual Regression Report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vr-report
          path: test-vr/playwright-report
          retention-days: 14

      - name: Fail workflow if tests failed
        # This step ensures that the entire job fails if the VR tests have failed.
        # This is necessary because of `continue-on-error: true` in the test step.
        # A failing job will block the PR from being merged.
        if: steps.vr_test_step.outcome == 'failure'
        run: exit 1

  deploy_staging:
    name: Deploy to Staging
    needs: [build_test_pack, vr_tests]
    # In GitHub Actions, when a job in the needs array fails, dependent jobs are skipped by default,
    # even if the if condition doesn't explicitly check that job's result.
    # Since the vr_tests job will fail when tests fail (due to the "Fail workflow if tests failed" step on line 263),
    # the deploy_staging job will be skipped. To achieve your intended behavior, you need to explicitly allow deploy_staging to run when vr_tests fails.
    if: always() && needs.build_test_pack.result == 'success' && (needs.vr_tests.result == 'success' || needs.vr_tests.result == 'failure')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Download website artifact
        uses: actions/download-artifact@v4
        with:
          name: website-build
          path: website-build

      - name: Download VR report artifact
        uses: actions/download-artifact@v4
        with:
          name: vr-report
          path: vr-report

      - name: Cleanup old PR deployments
        working-directory: gh-pages
        run: |
          # Find directories starting with "pr-" that haven't been modified in 30 days
          find . -maxdepth 1 -type d -name "pr-*" -mtime +30 -exec rm -rf {} +

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Deploy
        id: deploy
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        working-directory: gh-pages
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TARGET_DIR="pr-${{ github.event.pull_request.number }}"
          else
            TARGET_DIR="canary"
          fi

          # Remove existing directory if it exists
          rm -rf $TARGET_DIR
          mkdir -p $TARGET_DIR

          # Move artifacts to target directory
          mv ../website-build $TARGET_DIR/www
          mv ../vr-report $TARGET_DIR/vr-tests

          # Add and commit
          git add .
          git commit  --allow-empty --no-verify -m "Deploy to $TARGET_DIR"
          # Just in case there were other PRs running at the same time, pull first
          git pull --rebase
          git push --no-verify

          echo "Website deployed to URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$TARGET_DIR/www/"
          echo "VR report deployed to URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$TARGET_DIR/vr-tests/"

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.deploy.outcome == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          WEBSITE_URL="https://$REPO_OWNER.github.io/$REPO_NAME/pr-$PR_NUMBER/www/"
          REPORT_URL="https://$REPO_OWNER.github.io/$REPO_NAME/pr-$PR_NUMBER/vr-tests/"

          COMMENT_BODY=$(cat <<EOF
          **Staging Deployment Details**

          - **Website:** $WEBSITE_URL
          - **Test Report:** $REPORT_URL

          *These deployments will remain available for 30 days.*

          **To update snapshots:** Comment \`/update-snapshots\` on this PR to automatically update the baseline screenshots.
          EOF
          )

          gh pr comment $PR_NUMBER --repo ${{ github.repository }} --body "$COMMENT_BODY"
